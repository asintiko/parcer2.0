{"version":3,"mappings":"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","names":["passwordInput","monkey","onFirstMount","page","LoginPage","btnNext","Button","btnNextI18n","I18n","passwordInputField","PasswordInputField","resetLoading","resetLink","i18n","anchorCallback","rootScope","res","__vitePreload","m","err","SimpleConfirmationPopup","pageSignIn","waitTime","wrapFormattedDuration","formatDuration","toastNew","getStateInterval","getState","_state","state","replaceContent","htmlToSpan","wrapEmojiText","onSubmit","cancelEvent","toggle","toggleDisability","value","preloader","putPreloader","response","attachClickEvent","size","mediaSizes","PasswordMonkey","Page"],"ignoreList":[],"sources":["../src/pages/pagePassword.ts"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {putPreloader} from '../components/putPreloader';\r\nimport mediaSizes from '../helpers/mediaSizes';\r\nimport {AccountPassword} from '../layer';\r\nimport Page from './page';\r\nimport Button from '../components/button';\r\nimport PasswordInputField from '../components/passwordInputField';\r\nimport PasswordMonkey from '../components/monkeys/password';\r\nimport I18n, {i18n} from '../lib/langPack';\r\nimport LoginPage, {SimpleConfirmationPopup} from './loginPage';\r\nimport cancelEvent from '../helpers/dom/cancelEvent';\r\nimport {attachClickEvent} from '../helpers/dom/clickEvent';\r\nimport htmlToSpan from '../helpers/dom/htmlToSpan';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\nimport toggleDisability from '../helpers/dom/toggleDisability';\r\nimport wrapEmojiText from '../lib/richTextProcessor/wrapEmojiText';\r\nimport rootScope from '../lib/rootScope';\r\nimport anchorCallback from '../helpers/dom/anchorCallback';\r\nimport {toastNew} from '../components/toast';\r\nimport pageSignIn from './pageSignIn';\r\nimport formatDuration from '../helpers/formatDuration';\r\nimport {wrapFormattedDuration} from '../components/wrappers/wrapDuration';\r\n\r\nconst TEST = false;\r\nlet passwordInput: HTMLInputElement;\r\nlet monkey: PasswordMonkey;\r\n\r\nconst onFirstMount = (): Promise<any> => {\r\n  const page = new LoginPage({\r\n    className: 'page-password',\r\n    withInputWrapper: true,\r\n    titleLangKey: 'Login.Password.Title',\r\n    subtitleLangKey: 'Login.Password.Subtitle'\r\n  });\r\n\r\n  const btnNext = Button('btn-primary btn-color-primary');\r\n  const btnNextI18n = new I18n.IntlElement({key: 'Login.Next'});\r\n\r\n  btnNext.append(btnNextI18n.element);\r\n\r\n  const passwordInputField = new PasswordInputField({\r\n    label: 'LoginPassword',\r\n    name: 'password'\r\n  });\r\n\r\n  passwordInput = passwordInputField.input as HTMLInputElement;\r\n\r\n  let resetLoading = false\r\n  const resetLink = i18n('ForgotPassword', [\r\n    anchorCallback(() => {\r\n      if(resetLoading) return;\r\n      resetLoading = true;\r\n\r\n      rootScope.managers.passwordManager.requestRecovery().then((res) => {\r\n        return import('./pageEmailRecover').then((m) => {\r\n          m.default.mount({email_pattern: res.email_pattern});\r\n        })\r\n      }).catch(async(err: ApiError) => {\r\n        if(err.type === 'PASSWORD_RECOVERY_NA') {\r\n          await SimpleConfirmationPopup.show({\r\n            titleLangKey: 'Login.ResetPassword.Title',\r\n            descriptionLangKey: 'Login.ResetPassword.NoEmailText',\r\n            button: {\r\n              langKey: 'Login.ResetPassword.ResetAccount',\r\n              isDanger: true\r\n            }\r\n          })\r\n\r\n          await SimpleConfirmationPopup.show({\r\n            titleLangKey: 'Login.ResetAccount.Title',\r\n            descriptionLangKey: 'Login.ResetAccount.Text',\r\n            button: {\r\n              langKey: 'Login.ResetPassword.ResetAccount',\r\n              isDanger: true\r\n            }\r\n          })\r\n\r\n          // Promise.reject({type: '2FA_CONFIRM_WAIT_518400'})\r\n          await rootScope.managers.appAccountManager.deleteAccount('Forgot password')\r\n          .then(() => {\r\n            pageSignIn.mount();\r\n          }).catch((err: ApiError) => {\r\n            if(err.type === '2FA_RECENT_CONFIRM') {\r\n              SimpleConfirmationPopup.show({\r\n                titleLangKey: 'Login.ResetAccountFail.Title',\r\n                descriptionLangKey: 'Login.ResetAccountFail.TextCancelled',\r\n                button: {\r\n                  langKey: 'OK'\r\n                }\r\n              })\r\n            } else if(err.type.startsWith('2FA_CONFIRM_WAIT_')) {\r\n              const waitTime = +err.type.replace('2FA_CONFIRM_WAIT_', '');\r\n              SimpleConfirmationPopup.show({\r\n                titleLangKey: 'Login.ResetAccountFail.Title',\r\n                descriptionLangKey: 'Login.ResetAccountFail.TextWait',\r\n                descriptionArgs: [wrapFormattedDuration(formatDuration(waitTime))],\r\n                button: {\r\n                  langKey: 'OK'\r\n                }\r\n              })\r\n            } else {\r\n              console.error(err);\r\n              toastNew({langPackKey: 'Error.AnError'});\r\n            }\r\n          })\r\n          return\r\n        }\r\n\r\n        toastNew({langPackKey: 'Error.AnError'});\r\n      }).finally(() => {\r\n        resetLoading = false;\r\n      });\r\n    })\r\n  ]);\r\n  resetLink.classList.add('forgot-link');\r\n\r\n  page.inputWrapper.append(passwordInputField.container, resetLink, btnNext);\r\n\r\n  let getStateInterval: number;\r\n\r\n  const getState = () => {\r\n    // * just to check session relevance\r\n    if(!getStateInterval) {\r\n      getStateInterval = window.setInterval(getState, 10e3);\r\n    }\r\n\r\n    return !TEST && rootScope.managers.passwordManager.getState().then((_state) => {\r\n      state = _state;\r\n\r\n      if(state.hint) {\r\n        replaceContent(passwordInputField.label, htmlToSpan(wrapEmojiText(state.hint)));\r\n      } else {\r\n        passwordInputField.setLabel();\r\n      }\r\n    });\r\n  };\r\n\r\n  let state: AccountPassword;\r\n\r\n  const onSubmit = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(!passwordInput.value.length) {\r\n      passwordInput.classList.add('error');\r\n      return;\r\n    }\r\n\r\n    const toggle = toggleDisability([passwordInput, btnNext], true);\r\n    const value = passwordInput.value;\r\n\r\n    btnNextI18n.update({key: 'PleaseWait'});\r\n    const preloader = putPreloader(btnNext);\r\n\r\n    passwordInputField.setValueSilently('' + Math.random()); // prevent saving suggestion\r\n    passwordInputField.setValueSilently(value); // prevent saving suggestion\r\n\r\n    rootScope.managers.passwordManager.check(value, state).then((response) => {\r\n      // console.log('passwordManager response:', response);\r\n\r\n      switch(response._) {\r\n        case 'auth.authorization':\r\n          clearInterval(getStateInterval);\r\n          import('./pageIm').then((m) => {\r\n            m.default.mount();\r\n          });\r\n          if(monkey) monkey.remove();\r\n          break;\r\n        default:\r\n          btnNext.removeAttribute('disabled');\r\n          btnNextI18n.update({key: response._ as any});\r\n          preloader.remove();\r\n          break;\r\n      }\r\n    }).catch((err: any) => {\r\n      toggle();\r\n      passwordInputField.input.classList.add('error');\r\n\r\n      switch(err.type) {\r\n        default:\r\n          // btnNext.innerText = err.type;\r\n          btnNextI18n.update({key: 'PASSWORD_HASH_INVALID'});\r\n          passwordInput.select();\r\n          break;\r\n      }\r\n\r\n      preloader.remove();\r\n\r\n      getState();\r\n    });\r\n  };\r\n\r\n  attachClickEvent(btnNext, onSubmit);\r\n\r\n  passwordInput.addEventListener('keypress', function(this, e) {\r\n    this.classList.remove('error');\r\n    btnNextI18n.update({key: 'Login.Next'});\r\n\r\n    if(e.key === 'Enter') {\r\n      return onSubmit();\r\n    }\r\n  });\r\n\r\n  const size = mediaSizes.isMobile ? 100 : 166;\r\n  monkey = new PasswordMonkey(passwordInputField, size);\r\n  page.imageDiv.append(monkey.container);\r\n  return Promise.all([\r\n    monkey.load(),\r\n    getState()\r\n  ]);\r\n};\r\n\r\nconst page = new Page('page-password', true, onFirstMount, () => {\r\n  monkey?.load()\r\n}, () => {\r\n  // if(!isAppleMobile) {\r\n  passwordInput.focus();\r\n  // }\r\n\r\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStatePassword'});\r\n});\r\n\r\nexport default page;\r\n"],"file":"pagePassword-BYl8xcIr.js"}