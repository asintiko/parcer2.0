{"version":3,"file":"chatBackground-Chi5RRwr.js","sources":["../src/helpers/dom/focusInput.ts","../src/components/chat/patternRenderer.ts","../src/lib/chatBackgroundStore.ts","../src/helpers/easing/easeOutQuad.ts","../src/components/chat/gradientRenderer.ts","../src/helpers/averageColor.ts","../src/helpers/highlightingColor.ts","../src/components/chat/bubbles/chatBackground.tsx"],"sourcesContent":["import placeCaretAtEnd from './placeCaretAtEnd';\r\n\r\nexport default function focusInput(input: HTMLElement, e?: KeyboardEvent) {\r\n  input.focus();\r\n  placeCaretAtEnd(input);\r\n\r\n  if(e) {\r\n    // clone and dispatch same event to new input. it is needed for sending message if input was blurred\r\n    const newEvent = new KeyboardEvent(e.type, e);\r\n    input.dispatchEvent(newEvent);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from '../../helpers/array/indexOfAndSplice';\r\nimport deepEqual from '../../helpers/object/deepEqual';\r\nimport {renderImageFromUrlPromise} from '../../helpers/dom/renderImageFromUrl';\r\nimport mediaSizes, {ScreenSize} from '../../helpers/mediaSizes';\r\nimport windowSize from '../../helpers/windowSize';\r\nimport IS_IMAGE_BITMAP_SUPPORTED from '../../environment/imageBitmapSupport';\r\nimport {IS_FIREFOX} from '../../environment/userAgent';\r\n\r\nconst SCALE_PATTERN = false;\r\nconst USE_BITMAP = IS_IMAGE_BITMAP_SUPPORTED && IS_FIREFOX;\r\n\r\ntype ChatBackgroundPatternRendererInitOptions = {\r\n  element: HTMLElement;\r\n  url: string,\r\n  width: number,\r\n  height: number,\r\n  mask?: boolean\r\n};\r\n\r\nexport default class ChatBackgroundPatternRenderer {\r\n  private static INSTANCES: ChatBackgroundPatternRenderer[] = [];\r\n\r\n  // private pattern: CanvasPattern;\r\n  // private objectUrl: string;\r\n  private options: ChatBackgroundPatternRendererInitOptions;\r\n  private canvases: Set<HTMLCanvasElement>;\r\n  // private createCanvasPatternPromise: Promise<CanvasPattern>;\r\n  // private exportCanvasPatternToImagePromise: Promise<string>;\r\n  private renderImageFromUrlPromise: Promise<HTMLImageElement>;\r\n  private image: HTMLImageElement;\r\n  private imageBitmap: ImageBitmap;\r\n\r\n  constructor() {\r\n    this.canvases = new Set();\r\n  }\r\n\r\n  public static getInstance(options: ChatBackgroundPatternRendererInitOptions) {\r\n    let instance = this.INSTANCES.find((instance) => {\r\n      return instance.options.element === options.element && deepEqual(instance.options, options, ['element']);\r\n    });\r\n\r\n    if(!instance) {\r\n      instance = new ChatBackgroundPatternRenderer();\r\n      instance.init(options);\r\n      this.INSTANCES.push(instance);\r\n    }\r\n\r\n    return instance;\r\n  }\r\n\r\n  public init(options: ChatBackgroundPatternRendererInitOptions) {\r\n    // if(this.options) {\r\n    //   if(this.options.width !== options.width || this.options.height !== options.height) {\r\n    //     this.createCanvasPatternPromise =\r\n    //       this.pattern =\r\n    //       this.exportCanvasPatternToImagePromise =\r\n    //       undefined;\r\n    //   }\r\n    // }\r\n\r\n    this.options = options;\r\n  }\r\n\r\n  public renderToCanvas(canvas: HTMLCanvasElement) {\r\n    // return this.createCanvasPattern(canvas).then(() => {\r\n    // return this.fillCanvas(canvas);\r\n    // });\r\n\r\n    return this.renderImageFromUrl(this.options.url).then(() => {\r\n      return this.fillCanvas(canvas);\r\n    });\r\n  }\r\n\r\n  private renderImageFromUrl(url: string) {\r\n    if(this.renderImageFromUrlPromise) return this.renderImageFromUrlPromise;\r\n    const img = this.image = document.createElement('img');\r\n    img.crossOrigin = 'anonymous';\r\n    return this.renderImageFromUrlPromise = renderImageFromUrlPromise(img, url, false).then(() => {\r\n      if(!IS_IMAGE_BITMAP_SUPPORTED || !USE_BITMAP) {\r\n        return img;\r\n      }\r\n\r\n      return createImageBitmap(img, {\r\n        resizeWidth: 1440,\r\n        resizeHeight: 2960\r\n      }).then((imageBitmap) => {\r\n        this.imageBitmap = imageBitmap;\r\n        return img;\r\n      });\r\n    });\r\n  }\r\n\r\n  /* private createCanvasPattern(canvas: HTMLCanvasElement) {\r\n    if(this.createCanvasPatternPromise) return this.createCanvasPatternPromise;\r\n    return this.createCanvasPatternPromise = this.renderImageFromUrl(this.options.url).then((img) => {\r\n      let createPatternFrom: HTMLImageElement | HTMLCanvasElement;\r\n      if(IS_SAFARI) {\r\n        const canvas = createPatternFrom = document.createElement('canvas');\r\n        canvas.width = img.naturalWidth;\r\n        canvas.height = img.naturalHeight;\r\n        const ctx = canvas.getContext('2d');\r\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n      } else {\r\n        createPatternFrom = img;\r\n      }\r\n\r\n      const perf = performance.now();\r\n      this.pattern = canvas.getContext('2d').createPattern(createPatternFrom, 'repeat-x');\r\n      console.warn('creating pattern time:', performance.now() - perf);\r\n\r\n      return this.pattern;\r\n    });\r\n  }\r\n\r\n  public exportCanvasPatternToImage(canvas: HTMLCanvasElement) {\r\n    if(this.exportCanvasPatternToImagePromise) return this.exportCanvasPatternToImagePromise;\r\n    return this.exportCanvasPatternToImagePromise = new Promise<string>((resolve) => {\r\n      canvas.toBlob((blob) => {\r\n        const newUrl = this.objectUrl = URL.createObjectURL(blob);\r\n        resolve(newUrl);\r\n      }, 'image/png');\r\n    });\r\n  } */\r\n\r\n  public cleanup(canvas: HTMLCanvasElement) {\r\n    this.canvases.delete(canvas);\r\n\r\n    if(!this.canvases.size) {\r\n      indexOfAndSplice(ChatBackgroundPatternRenderer.INSTANCES, this);\r\n\r\n      this.imageBitmap?.close();\r\n      // if(this.objectUrl) {\r\n      //   URL.revokeObjectURL(this.objectUrl);\r\n      // }\r\n    }\r\n  }\r\n\r\n  public fillCanvas(canvas: HTMLCanvasElement) {\r\n    const context = canvas.getContext('2d');\r\n    const {width, height} = canvas;\r\n    // const perf = performance.now();\r\n    // if(context.fillStyle instanceof CanvasPattern) {\r\n    //   context.clearRect(0, 0, width, height);\r\n    // }\r\n\r\n    const source = this.imageBitmap || this.image;\r\n\r\n    let imageWidth = source.width, imageHeight = source.height;\r\n    // let patternHeight = 1480 * canvas.dpr;\r\n    // if(+canvas.dataset.originalHeight !== height) patternHeight *= .6875;\r\n    const patternHeight = (500 + (windowSize.height / 2.5)) * canvas.dpr;\r\n    const ratio = patternHeight / imageHeight;\r\n    imageWidth *= ratio;\r\n    imageHeight = patternHeight;\r\n\r\n    if(this.options.mask) {\r\n      context.fillStyle = '#000';\r\n      context.fillRect(0, 0, width, height);\r\n      context.globalCompositeOperation = 'destination-out';\r\n    } else {\r\n      context.globalCompositeOperation = 'source-over';\r\n    }\r\n\r\n    const d = (y: number) => {\r\n      for(let x = 0; x < width; x += imageWidth) {\r\n        context.drawImage(source, x, y, imageWidth, imageHeight);\r\n      }\r\n    };\r\n\r\n    const centerY = (height - imageHeight) / 2;\r\n    d(centerY);\r\n\r\n    if(centerY > 0) {\r\n      let topY = centerY;\r\n      do {\r\n        d(topY -= imageHeight);\r\n      } while(topY >= 0);\r\n    }\r\n\r\n    const endY = height - 1;\r\n    for(let bottomY = centerY + imageHeight; bottomY < endY; bottomY += imageHeight) {\r\n      d(bottomY);\r\n    }\r\n\r\n    // for(let x = 0; x < width; x += imageWidth) {\r\n    //   for(let y = 0; y < height; y += imageHeight) {\r\n    //     context.drawImage(img, x, y, imageWidth, imageHeight);\r\n    //   }\r\n    // }\r\n    // context.fillStyle = this.pattern;\r\n    // context.fillRect(0, 0, width, height);\r\n    // console.warn('fill canvas time', performance.now() - perf);\r\n  }\r\n\r\n  public setCanvasDimensions(canvas: HTMLCanvasElement) {\r\n    const devicePixelRatio = Math.min(2, window.devicePixelRatio);\r\n    const width = this.options.width * devicePixelRatio;\r\n    let height = this.options.height * devicePixelRatio;\r\n\r\n    canvas.dpr = devicePixelRatio;\r\n    canvas.dataset.originalHeight = '' + height;\r\n    if(mediaSizes.activeScreen === ScreenSize.large && SCALE_PATTERN) height *= 1.5;\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n  }\r\n\r\n  public createCanvas() {\r\n    const canvas = document.createElement('canvas');\r\n    this.canvases.add(canvas);\r\n    this.setCanvasDimensions(canvas);\r\n    return canvas;\r\n  }\r\n\r\n  public resize(width: number, height: number) {\r\n    this.init({\r\n      ...this.options,\r\n      width,\r\n      height\r\n    });\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(const canvas of this.canvases) {\r\n      this.setCanvasDimensions(canvas);\r\n      promises.push(this.renderToCanvas(canvas));\r\n    }\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  public static resizeInstancesOf(element: HTMLElement) {\r\n    const toResize = this.INSTANCES.filter(instance => instance.options.element === element);\r\n\r\n    const rect = element.getBoundingClientRect();\r\n\r\n    return Promise.all(toResize.map((instance) => instance.resize(rect.width, rect.height)));\r\n  }\r\n\r\n  /* public setResizeMode(resizing: boolean) {\r\n    const canvases = Array.from(this.canvases);\r\n    const canvas = canvases[canvases.length - 1];\r\n    canvas.style.display = resizing ? 'none' : '';\r\n    const img = this.img;\r\n    img.style.display = resizing ? '' : 'none';\r\n\r\n    return {img, canvas};\r\n  } */\r\n}\r\n","import {DEFAULT_BACKGROUND_SLUG} from '../config/app';\r\nimport blur from '../helpers/blur';\r\nimport type {Document, WallPaper} from '../layer';\r\n\r\nimport type AppDownloadManagerInstance from './appManagers/appDownloadManager';\r\nimport type {AppManagers} from './appManagers/managers';\r\nimport CacheStorageController from './files/cacheStorage';\r\nimport StaticUtilityClass from './staticUtilityClass';\r\n\r\n\r\nnamespace ChatBackgroundStore {\r\n  export type BackgroundPromises = {\r\n    [url: string]: MaybePromise<string>\r\n  };\r\n\r\n  export type GetBackgroundArgs = {\r\n    slug: string;\r\n    canDownload?: boolean;\r\n    blur?: boolean;\r\n\r\n    managers?: AppManagers;\r\n    appDownloadManager?: typeof AppDownloadManagerInstance;\r\n  };\r\n\r\n  export type SetBackgroundUrlToCacheArgs = {\r\n    slug: string;\r\n    url: string;\r\n    blur?: boolean;\r\n  };\r\n}\r\n\r\nclass ChatBackgroundStore extends StaticUtilityClass {\r\n  private static cacheStorage = new CacheStorageController('cachedBackgrounds');\r\n  private static backgroundPromises: ChatBackgroundStore.BackgroundPromises = {};\r\n\r\n  public static getWallPaperStorageUrl(slug: string, blur?: boolean) {\r\n    return `backgrounds/${slug}${blur ? '?blur' : ''}`;\r\n  }\r\n\r\n  public static hasWallPaperStorageUrl(slug: string, blur?: boolean) {\r\n    const storageUrl = this.getWallPaperStorageUrl(slug, blur);\r\n    return this.cacheStorage.has(storageUrl);\r\n  }\r\n\r\n  public static getBackground({\r\n    slug,\r\n    canDownload,\r\n    blur,\r\n\r\n    managers,\r\n    appDownloadManager\r\n  }: ChatBackgroundStore.GetBackgroundArgs) {\r\n    const storageUrl = this.getWallPaperStorageUrl(slug, blur);\r\n    const canReallyDownload = canDownload && !!managers && !!appDownloadManager;\r\n\r\n    return this.backgroundPromises[storageUrl] ||= this.cacheStorage.getFile(storageUrl).then((blob) => {\r\n      return this.backgroundPromises[storageUrl] = URL.createObjectURL(blob);\r\n    }, canReallyDownload ? async(err) => {\r\n      if((err as ApiError).type !== 'NO_ENTRY_FOUND') {\r\n        throw err;\r\n      }\r\n\r\n      const wallPaper = await managers.appThemesManager.getWallPaperBySlug(slug);\r\n      let url = await appDownloadManager.downloadMediaURL({\r\n        media: (wallPaper as WallPaper.wallPaper).document as Document.document\r\n      });\r\n\r\n      if(blur) {\r\n        url = await this.blurWallPaperImage(url);\r\n      }\r\n\r\n      this.saveWallPaperToCache(slug, url, blur);\r\n      return this.backgroundPromises[storageUrl] = url;\r\n    } : undefined);\r\n  }\r\n\r\n  public static blurWallPaperImage(url: string) {\r\n    const {canvas, promise} = blur(url, 12, 4);\r\n    return promise.then(() => {\r\n      return canvas.toDataURL();\r\n    });\r\n  }\r\n\r\n  public static saveWallPaperToCache(slug: string, url: string, blur?: boolean) {\r\n    if(!slug || slug === DEFAULT_BACKGROUND_SLUG) {\r\n      return;\r\n    }\r\n\r\n    return fetch(url).then((response) => {\r\n      return this.cacheStorage.save(this.getWallPaperStorageUrl(slug, blur), response);\r\n    });\r\n  }\r\n\r\n  public static setBackgroundUrlToCache({slug, url, blur}: ChatBackgroundStore.SetBackgroundUrlToCacheArgs) {\r\n    this.backgroundPromises[this.getWallPaperStorageUrl(slug, blur)] = url;\r\n  }\r\n}\r\n\r\nexport default ChatBackgroundStore;\r\n","export default function easeOutQuad(t: number, b: number, c: number, d: number) {\r\n  return t >= d ? b + c : easeOutQuadApply(t / d, c) + b;\r\n}\r\n\r\nexport function easeOutQuadApply(v: number, c: number) {\r\n  return -c * v * (v - 2);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko, Artem Kolnogorov and unknown creator of the script taken from http://useless.altervista.org/gradient.html\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {animateSingle} from '../../helpers/animation';\r\nimport {hexToRgb} from '../../helpers/color';\r\nimport {easeOutQuadApply} from '../../helpers/easing/easeOutQuad';\r\n\r\nconst WIDTH = 50;\r\nconst HEIGHT = WIDTH;\r\n\r\ntype Point = {x: number, y: number};\r\n\r\nexport default class ChatBackgroundGradientRenderer {\r\n  private readonly _width = WIDTH;\r\n  private readonly _height = HEIGHT;\r\n  private _phase: number;\r\n  private _tail: number;\r\n  private readonly _tails = 90;\r\n  // private readonly _scrollTails = 50;\r\n  private _frames: ImageData[];\r\n  private _colors: {r: number, g: number, b: number}[];\r\n  private readonly _curve = [\r\n    0, 0.25, 0.50, 0.75, 1, 1.5, 2, 2.5, 3, 3.5, 4, 5, 6, 7, 8, 9, 10, 11, 12,\r\n    13, 14, 15, 16, 17, 18, 18.3, 18.6, 18.9, 19.2, 19.5, 19.8, 20.1, 20.4, 20.7,\r\n    21.0, 21.3, 21.6, 21.9, 22.2, 22.5, 22.8, 23.1, 23.4, 23.7, 24.0, 24.3, 24.6,\r\n    24.9, 25.2, 25.5, 25.8, 26.1, 26.3, 26.4, 26.5, 26.6, 26.7, 26.8, 26.9, 27\r\n  ];\r\n  private readonly _incrementalCurve: number[];\r\n  private readonly _positions: Point[] = [\r\n    {x: 0.80, y: 0.10},\r\n    {x: 0.60, y: 0.20},\r\n    {x: 0.35, y: 0.25},\r\n    {x: 0.25, y: 0.60},\r\n    {x: 0.20, y: 0.90},\r\n    {x: 0.40, y: 0.80},\r\n    {x: 0.65, y: 0.75},\r\n    {x: 0.75, y: 0.40}\r\n  ];\r\n  private readonly _phases = this._positions.length;\r\n  // private _onWheelRAF: number;\r\n  // private _scrollDelta: number;\r\n\r\n  // private _ts = 0;\r\n  // private _fps = 15;\r\n  // private _frametime = 1000 / this._fps;\r\n  // private _raf: number;\r\n\r\n  private _canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _hc: HTMLCanvasElement;\r\n  private _hctx: CanvasRenderingContext2D;\r\n\r\n  // private _addedScrollListener: boolean;\r\n  private _animatingToNextPosition: boolean;\r\n  private _nextPositionTail: number;\r\n  private _nextPositionTails: number;\r\n  private _nextPositionLeft: number;\r\n\r\n  constructor() {\r\n    const diff = this._tails / this._curve[this._curve.length - 1];\r\n\r\n    for(let i = 0, length = this._curve.length; i < length; ++i) {\r\n      this._curve[i] = this._curve[i] * diff;\r\n    }\r\n\r\n    this._incrementalCurve = this._curve.map((v, i, arr) => {\r\n      return v - (arr[i - 1] ?? 0);\r\n    });\r\n  }\r\n\r\n  private hexToRgb(hex: string) {\r\n    const result = hexToRgb(hex);\r\n    return {r: result[0], g: result[1], b: result[2]};\r\n  }\r\n\r\n  private getPositions(shift: number) {\r\n    const positions = this._positions.slice();\r\n    positions.push(...positions.splice(0, shift));\r\n\r\n    const result: typeof positions = [];\r\n    for(let i = 0; i < positions.length; i += 2) {\r\n      result.push(positions[i]);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private getNextPositions(phase: number, curveMax: number, curve: number[]) {\r\n    const pos = this.getPositions(phase);\r\n    if(!curve[0] && curve.length === 1) {\r\n      return [pos];\r\n    }\r\n\r\n    const nextPos = this.getPositions(++phase % this._phases);\r\n    const distances = nextPos.map((nextPos, idx) => {\r\n      return {\r\n        x: (nextPos.x - pos[idx].x) / curveMax,\r\n        y: (nextPos.y - pos[idx].y) / curveMax\r\n      };\r\n    });\r\n\r\n    const positions = curve.map((value) => {\r\n      return distances.map((distance, idx) => {\r\n        return {\r\n          x: pos[idx].x + distance.x * value,\r\n          y: pos[idx].y + distance.y * value\r\n        };\r\n      });\r\n    });\r\n\r\n    return positions;\r\n  }\r\n\r\n  private curPosition(phase: number, tail: number) {\r\n    const positions = this.getNextPositions(phase, this._tails, [tail]);\r\n    return positions[0];\r\n  }\r\n\r\n  private changeTail(diff: number) {\r\n    this._tail += diff;\r\n\r\n    while(this._tail >= this._tails) {\r\n      this._tail -= this._tails;\r\n      if(++this._phase >= this._phases) {\r\n        this._phase -= this._phases;\r\n      }\r\n    }\r\n\r\n    while(this._tail < 0) {\r\n      this._tail += this._tails;\r\n      if(--this._phase < 0) {\r\n        this._phase += this._phases;\r\n      }\r\n    }\r\n  }\r\n\r\n  // private onWheel = (e: {deltaY: number}) => {\r\n  //   if(this._animatingToNextPosition) {\r\n  //     return;\r\n  //   }\r\n\r\n  //   this._scrollDelta += e.deltaY;\r\n  //   if(this._onWheelRAF === undefined) {\r\n  //     this._onWheelRAF = requestAnimationFrame(this.drawOnWheel);\r\n  //   }\r\n  // };\r\n\r\n  private changeTailAndDraw(diff: number) {\r\n    this.changeTail(diff);\r\n    const curPos = this.curPosition(this._phase, this._tail);\r\n    this.drawGradient(curPos);\r\n  }\r\n\r\n  // private drawOnWheel = () => {\r\n  //   const value = this._scrollDelta / this._scrollTails;\r\n  //   this._scrollDelta %= this._scrollTails;\r\n  //   const diff = value > 0 ? Math.floor(value) : Math.ceil(value);\r\n  //   if(diff) {\r\n  //     this.changeTailAndDraw(diff);\r\n  //   }\r\n  //   this._onWheelRAF = undefined;\r\n  // };\r\n\r\n  private drawNextPositionAnimated = (getProgress?: () => number) => {\r\n    let done: boolean, id: ImageData;\r\n    if(getProgress) {\r\n      const value = getProgress();\r\n      done = value >= 1;\r\n      const transitionValue = easeOutQuadApply(value, 1);\r\n      const nextPositionTail = this._nextPositionTail ?? 0;\r\n      const tail = this._nextPositionTail = this._nextPositionTails * transitionValue;\r\n      const diff = tail - nextPositionTail;\r\n      if(diff) {\r\n        this._nextPositionLeft -= diff;\r\n        this.changeTailAndDraw(-diff);\r\n      }\r\n    } else {\r\n      const frames = this._frames;\r\n      id = frames.shift();\r\n      done = !frames.length;\r\n    }\r\n\r\n    if(id) {\r\n      this.drawImageData(id);\r\n    }\r\n\r\n    if(done) {\r\n      this._nextPositionLeft = undefined;\r\n      this._nextPositionTails = undefined;\r\n      this._nextPositionTail = undefined;\r\n      this._animatingToNextPosition = undefined;\r\n    }\r\n\r\n    return !done;\r\n  };\r\n\r\n  private getGradientImageData(positions: Point[], phase = this._phase, progress = 1 - this._tail / this._tails) {\r\n    const id = this._hctx.createImageData(this._width, this._height);\r\n    const pixels = id.data;\r\n    const colorsLength = this._colors.length;\r\n\r\n    const positionsForPhase = (phase: number) => {\r\n      const result: typeof positions = [];\r\n      for(let i = 0; i != 4; ++i) {\r\n        result[i] = {...this._positions[(phase + i * 2) % this._positions.length]};\r\n        result[i].y = 1.0 - result[i].y;\r\n      }\r\n      return result;\r\n    };\r\n\r\n    const previousPhase = (phase + 1) % this._positions.length;\r\n    const previous = positionsForPhase(previousPhase);\r\n    const current = positionsForPhase(phase);\r\n\r\n    let offset = 0;\r\n    for(let y = 0; y < this._height; ++y) {\r\n      const directPixelY = y / this._height;\r\n      const centerDistanceY = directPixelY - 0.5;\r\n      const centerDistanceY2 = centerDistanceY * centerDistanceY;\r\n      for(let x = 0; x < this._width; ++x) {\r\n        const directPixelX = x / this._width;\r\n        const centerDistanceX = directPixelX - 0.5;\r\n        const centerDistance = Math.sqrt(centerDistanceX * centerDistanceX + centerDistanceY2);\r\n\r\n        const swirlFactor = 0.35 * centerDistance;\r\n        const theta = swirlFactor * swirlFactor * 0.8 * 8.0;\r\n        const sinTheta = Math.sin(theta);\r\n        const cosTheta = Math.cos(theta);\r\n\r\n        const pixelX = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * cosTheta - centerDistanceY * sinTheta));\r\n        const pixelY = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * sinTheta + centerDistanceY * cosTheta));\r\n\r\n        let distanceSum = 0.0;\r\n        let r = 0.0;\r\n        let g = 0.0;\r\n        let b = 0.0;\r\n        for(let i = 0; i < colorsLength; ++i) {\r\n          const colorX = previous[i].x + (current[i].x - previous[i].x) * progress;\r\n          const colorY = previous[i].y + (current[i].y - previous[i].y) * progress;\r\n\r\n          const distanceX = pixelX - colorX;\r\n          const distanceY = pixelY - colorY;\r\n\r\n          let distance = Math.max(0.0, 0.9 - Math.sqrt(distanceX * distanceX + distanceY * distanceY));\r\n          distance = distance * distance * distance * distance;\r\n          distanceSum += distance;\r\n\r\n          r += distance * this._colors[i].r;\r\n          g += distance * this._colors[i].g;\r\n          b += distance * this._colors[i].b;\r\n        }\r\n\r\n        pixels[offset++] = r / distanceSum;\r\n        pixels[offset++] = g / distanceSum;\r\n        pixels[offset++] = b / distanceSum;\r\n        pixels[offset++] = 0xFF;\r\n      }\r\n    }\r\n    return id;\r\n  }\r\n\r\n  private drawImageData(id: ImageData) {\r\n    this._hctx.putImageData(id, 0, 0);\r\n    this._ctx.drawImage(this._hc, 0, 0, this._width, this._height);\r\n  }\r\n\r\n  private drawGradient(positions: Point[]) {\r\n    this.drawImageData(this.getGradientImageData(positions));\r\n  }\r\n\r\n  // private doAnimate = () => {\r\n  //   const now = +Date.now();\r\n  //   if(!document.hasFocus() || (now - this._ts) < this._frametime) {\r\n  //     this._raf = requestAnimationFrame(this.doAnimate);\r\n  //     return;\r\n  //   }\r\n\r\n  //   this._ts = now;\r\n  //   this.changeTail(1);\r\n  //   const cur_pos = this.curPosition(this._phase, this._tail);\r\n  //   this.drawGradient(cur_pos);\r\n  //   this._raf = requestAnimationFrame(this.doAnimate);\r\n  // };\r\n\r\n  // public animate(start?: boolean) {\r\n  //   if(!start) {\r\n  //     cancelAnimationFrame(this._raf);\r\n  //     return;\r\n  //   }\r\n  //   this.doAnimate();\r\n  // }\r\n\r\n  public init(el: HTMLCanvasElement) {\r\n    this._frames = [];\r\n    this._phase = 0;\r\n    this._tail = 0;\r\n    // this._scrollDelta = 0;\r\n    // if(this._onWheelRAF !== undefined) {\r\n    //   cancelAnimationFrame(this._onWheelRAF);\r\n    //   this._onWheelRAF = undefined;\r\n    // }\r\n\r\n    const colors = el.getAttribute('data-colors').split(',');\r\n    this._colors = colors.map((color) => {\r\n      return this.hexToRgb(color);\r\n    });\r\n\r\n    if(!this._hc) {\r\n      this._hc = document.createElement('canvas');\r\n      this._hc.width = this._width;\r\n      this._hc.height = this._height;\r\n      this._hctx = this._hc.getContext('2d', {alpha: false});\r\n    }\r\n\r\n    this._canvas = el;\r\n    this._ctx = this._canvas.getContext('2d', {alpha: false});\r\n    this.update();\r\n  }\r\n\r\n  private update() {\r\n    if(this._colors.length < 2) {\r\n      const color = this._colors[0];\r\n      this._ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;\r\n      this._ctx.fillRect(0, 0, this._width, this._height);\r\n      return;\r\n    }\r\n\r\n    const position = this.curPosition(this._phase, this._tail);\r\n    this.drawGradient(position);\r\n  }\r\n\r\n  public toNextPosition(getProgress?: () => number) {\r\n    if(this._colors.length < 2) {\r\n      return;\r\n    }\r\n\r\n    if(getProgress) {\r\n      this._nextPositionLeft = this._tails + (this._nextPositionLeft ?? 0);\r\n      this._nextPositionTails = this._nextPositionLeft;\r\n      this._nextPositionTail = undefined;\r\n      this._animatingToNextPosition = true;\r\n      animateSingle(this.drawNextPositionAnimated.bind(this, getProgress), this);\r\n      return;\r\n    }\r\n\r\n    const tail = this._tail;\r\n    const tails = this._tails;\r\n\r\n    let nextPhaseOnIdx: number;\r\n\r\n    const curve: number[] = [];\r\n    for(let i = 0, length = this._incrementalCurve.length; i < length; ++i) {\r\n      const inc = this._incrementalCurve[i];\r\n      let value = (curve[i - 1] ?? tail) + inc;\r\n\r\n      if(+value.toFixed(2) > tails && nextPhaseOnIdx === undefined) {\r\n        nextPhaseOnIdx = i;\r\n        value %= tails;\r\n      }\r\n\r\n      curve.push(value);\r\n    }\r\n\r\n    const currentPhaseCurve = curve.slice(0, nextPhaseOnIdx);\r\n    const nextPhaseCurve = nextPhaseOnIdx !== undefined ? curve.slice(nextPhaseOnIdx) : [];\r\n\r\n    [currentPhaseCurve, nextPhaseCurve].forEach((curve, idx, curves) => {\r\n      const last = curve[curve.length - 1];\r\n      if(last !== undefined && last > tails) {\r\n        curve[curve.length - 1] = +last.toFixed(2);\r\n      }\r\n\r\n      this._tail = last ?? 0;\r\n\r\n      if(!curve.length) {\r\n        return;\r\n      }\r\n\r\n      const positions = this.getNextPositions(this._phase, tails, curve);\r\n      if(idx !== (curves.length - 1)) {\r\n        if(++this._phase >= this._phases) {\r\n          this._phase -= this._phases;\r\n        }\r\n      }\r\n\r\n      const ids = positions.map((pos) => {\r\n        return this.getGradientImageData(pos);\r\n      });\r\n\r\n      this._frames.push(...ids);\r\n    });\r\n\r\n    this._animatingToNextPosition = true;\r\n    animateSingle(this.drawNextPositionAnimated, this);\r\n  }\r\n\r\n  // public toNextPositionThrottled = throttle(this.toNextPosition.bind(this), 100, true);\r\n\r\n  // public scrollAnimate(start?: boolean) {\r\n  //   return;\r\n\r\n  //   if(this._colors.length < 2 && start) {\r\n  //     return;\r\n  //   }\r\n\r\n  //   if(start && !this._addedScrollListener) {\r\n  //     document.addEventListener('wheel', this.onWheel);\r\n  //     this._addedScrollListener = true;\r\n  //   } else if(!start && this._addedScrollListener) {\r\n  //     document.removeEventListener('wheel', this.onWheel);\r\n  //     this._addedScrollListener = false;\r\n  //   }\r\n  // }\r\n\r\n  public cleanup() {\r\n    // this.scrollAnimate(false);\r\n    // this.animate(false);\r\n  }\r\n\r\n  public static createCanvas(colors?: string) {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = WIDTH;\r\n    canvas.height = HEIGHT;\r\n    if(colors !== undefined) {\r\n      canvas.dataset.colors = colors;\r\n    }\r\n\r\n    return canvas;\r\n  }\r\n\r\n  public static create(colors?: string) {\r\n    const canvas = this.createCanvas(colors);\r\n    const gradientRenderer = new ChatBackgroundGradientRenderer();\r\n    gradientRenderer.init(canvas);\r\n\r\n    return {gradientRenderer, canvas};\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {renderImageFromUrlPromise} from './dom/renderImageFromUrl';\r\n\r\nexport function averageColorFromCanvas(canvas: HTMLCanvasElement) {\r\n  const context = canvas.getContext('2d');\r\n\r\n  const pixel = new Array(4).fill(0);\r\n  const pixels = context.getImageData(0, 0, canvas.width, canvas.height).data;\r\n  const pixelsLength = pixels.length / 4;\r\n  for(let i = 0; i < pixels.length; i += 4) {\r\n    // const alphaPixel = pixels[i + 3];\r\n    pixel[0] += pixels[i]/*  * (alphaPixel / 255) */;\r\n    pixel[1] += pixels[i + 1]/*  * (alphaPixel / 255) */;\r\n    pixel[2] += pixels[i + 2]/*  * (alphaPixel / 255) */;\r\n    pixel[3] += pixels[i + 3];\r\n  }\r\n\r\n  const outPixel = new Uint8ClampedArray(4);\r\n  outPixel[0] = pixel[0] / pixelsLength;\r\n  outPixel[1] = pixel[1] / pixelsLength;\r\n  outPixel[2] = pixel[2] / pixelsLength;\r\n  outPixel[3] = pixel[3] / pixelsLength;\r\n  // outPixel[3] = 255;\r\n  return outPixel;\r\n}\r\n\r\nexport function averageColorFromImageSource(imageSource: CanvasImageSource, width: number, height: number) {\r\n  const canvas = document.createElement('canvas');\r\n  const ratio = width / height;\r\n  const DIMENSIONS = 50;\r\n  if(ratio === 1) {\r\n    canvas.width = DIMENSIONS;\r\n    canvas.height = canvas.width / ratio;\r\n  } else if(ratio > 1) {\r\n    canvas.height = DIMENSIONS;\r\n    canvas.width = canvas.height / ratio;\r\n  } else {\r\n    canvas.width = canvas.height = DIMENSIONS;\r\n  }\r\n\r\n  const context = canvas.getContext('2d');\r\n  context.drawImage(imageSource, 0, 0, width, height, 0, 0, canvas.width, canvas.height);\r\n  return averageColorFromCanvas(canvas);\r\n}\r\n\r\nexport function averageColorFromImage(image: HTMLImageElement) {\r\n  return averageColorFromImageSource(image, image.naturalWidth, image.naturalHeight);\r\n}\r\n\r\nexport async function averageColor(imageUrl: string) {\r\n  const img = document.createElement('img');\r\n  await renderImageFromUrlPromise(img, imageUrl, false);\r\n  return averageColorFromImage(img);\r\n};\r\n","import {rgbaToHsla} from './color';\r\n\r\n// * https://github.com/TelegramMessenger/Telegram-iOS/blob/3d062fff78cc6b287c74e6171f855a3500c0156d/submodules/TelegramPresentationData/Sources/PresentationData.swift#L453\r\nexport default function highlightingColor(rgba: [number, number, number, number?]) {\r\n  let {h, s, l} = rgbaToHsla(rgba[0], rgba[1], rgba[2]);\r\n  if(s > 0) {\r\n    s = Math.min(100, s + 5 + 0.1 * (100 - s));\r\n  }\r\n  l = Math.max(0, l * .65);\r\n\r\n  const hsla = `hsla(${h}, ${s}%, ${l}%, .4)`;\r\n  return hsla;\r\n}\r\n","import {batch, createSignal, onCleanup, onMount} from 'solid-js';\r\nimport ChatBackgroundPatternRenderer from '../patternRenderer';\r\nimport {DEFAULT_BACKGROUND_SLUG} from '../../../config/app';\r\nimport ChatBackgroundStore from '../../../lib/chatBackgroundStore';\r\nimport {ThemeController} from '../../../helpers/themeController';\r\nimport {Theme, WallPaper} from '../../../layer';\r\nimport {AppTheme, SETTINGS_INIT} from '../../../config/state';\r\n\r\nimport styles from './chatBackground.module.scss';\r\nimport renderImageFromUrl from '../../../helpers/dom/renderImageFromUrl';\r\nimport {getColorsFromWallPaper} from '../../../helpers/color';\r\nimport ChatBackgroundGradientRenderer from '../gradientRenderer';\r\nimport classNames from '../../../helpers/string/classNames';\r\nimport {AppManagers} from '../../../lib/appManagers/managers';\r\nimport {appState} from '../../../stores/appState';\r\nimport {averageColorFromCanvas, averageColorFromImage} from '../../../helpers/averageColor';\r\nimport highlightingColor from '../../../helpers/highlightingColor';\r\n\r\nasync function getBackgroundParameters(options: {\r\n  themeController: ThemeController\r\n  managers: AppManagers\r\n  peerId?: PeerId\r\n}) {\r\n  const {\r\n    themeController,\r\n    managers,\r\n    peerId\r\n  } = options;\r\n\r\n  let theme: AppTheme | Theme = themeController.getTheme();\r\n  let wallPaper = themeController.getThemeSettings(theme).wallpaper as WallPaper.wallPaper;\r\n\r\n  if(peerId && peerId.isUser()) {\r\n    const full = await managers.appProfileManager.getCachedFullUser(peerId.toUserId())\r\n    if(full?.wallpaper) {\r\n      wallPaper = full.wallpaper as WallPaper.wallPaper;\r\n    } else if(full?.theme) {\r\n      const themeEmoticon = 'emoticon' in full.theme ? full.theme.emoticon : undefined;\r\n      const acctTheme = appState.accountThemes.themes?.find((theme) => theme.emoticon === themeEmoticon);\r\n      if(acctTheme) {\r\n        theme = acctTheme;\r\n        const themeWallPaper = acctTheme?.settings.find(it => it.wallpaper)?.wallpaper;\r\n        if(themeWallPaper) {\r\n          wallPaper = themeWallPaper as WallPaper.wallPaper;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  let backgroundUrl: string;\r\n  try {\r\n    backgroundUrl = getBackgroundURL(wallPaper.slug, wallPaper.settings?.pFlags.blur); // expected to throw if no cache available\r\n  } catch{\r\n    backgroundUrl = getBackgroundURL(DEFAULT_BACKGROUND_SLUG);\r\n  }\r\n\r\n  const isPattern = !!(wallPaper as WallPaper.wallPaper)?.pFlags?.pattern;\r\n  const intensity = wallPaper.settings?.intensity && wallPaper.settings.intensity / 100;\r\n  const isDarkPattern = !!intensity && intensity < 0;\r\n\r\n  return {\r\n    theme,\r\n    backgroundUrl,\r\n    isPattern,\r\n    isDarkPattern,\r\n    intensity,\r\n    wallPaper\r\n  };\r\n}\r\n\r\nfunction getBackgroundURL(slug: string, blur?: boolean) {\r\n  if(slug === DEFAULT_BACKGROUND_SLUG) {\r\n    return 'assets/img/pattern.svg'\r\n  }\r\n\r\n  /**\r\n     * This delays when the background appears and makes it blink after refresh ☹️\r\n     */\r\n  // const hasInCache = await ChatBackgroundStore.hasWallPaperStorageUrl(slug);\r\n  // if(!hasInCache) throw new Error('No background with this slug found in cache');\r\n\r\n  return ChatBackgroundStore.getWallPaperStorageUrl(slug, blur);\r\n}\r\n\r\nasync function ensureImageLoaded(image: HTMLImageElement) {\r\n  if(!image.naturalWidth) {\r\n    await new Promise((resolve) => {\r\n      image.addEventListener('load', resolve, {once: true});\r\n    });\r\n  }\r\n}\r\n\r\nexport function ChatBackground(props: {\r\n  class?: string\r\n  themeController: ThemeController\r\n  managers: AppManagers\r\n  peerId?: PeerId\r\n  gradientRendererRef?: (value: ChatBackgroundGradientRenderer | undefined) => void\r\n  onHighlightColor?: (hsla: string) => void\r\n}) {\r\n  let container!: HTMLDivElement;\r\n\r\n  const [patternCanvas, setPatternCanvas] = createSignal<HTMLCanvasElement>();\r\n  const [gradientCanvas, setGradientCanvas] = createSignal<HTMLCanvasElement>();\r\n  const [image, setImage] = createSignal<HTMLImageElement>();\r\n  const [url, setUrl] = createSignal<string>();\r\n\r\n  async function createBackground() {\r\n    const {\r\n      backgroundUrl,\r\n      isPattern,\r\n      isDarkPattern,\r\n      intensity,\r\n      wallPaper\r\n    } = await getBackgroundParameters(props);\r\n\r\n    setUrl(backgroundUrl);\r\n\r\n    let\r\n      image: HTMLImageElement,\r\n      patternCanvas: HTMLCanvasElement,\r\n      gradientCanvas: HTMLCanvasElement,\r\n      patternRenderer: ChatBackgroundPatternRenderer\r\n    ;\r\n\r\n    if(backgroundUrl) {\r\n      if(isPattern) {\r\n        const rect = container.getBoundingClientRect();\r\n        const patternRenderer = ChatBackgroundPatternRenderer.getInstance({\r\n          element: container,\r\n          url: backgroundUrl,\r\n          width: rect.width,\r\n          height: rect.height,\r\n          mask: isDarkPattern\r\n        });\r\n\r\n        patternCanvas = patternRenderer.createCanvas();\r\n        patternCanvas.classList.add(styles.CanvasCommon)\r\n        if(!isDarkPattern) patternCanvas.classList.add(styles.blend);\r\n\r\n        patternRenderer.renderToCanvas(patternCanvas);\r\n      } else {\r\n        image = document.createElement('img');\r\n        image.classList.add(styles.CanvasCommon);\r\n        renderImageFromUrl(image, backgroundUrl);\r\n      }\r\n    }\r\n\r\n    const colors = getColorsFromWallPaper(wallPaper);\r\n    if(colors) {\r\n      const {canvas, gradientRenderer} = ChatBackgroundGradientRenderer.create(colors);\r\n      gradientCanvas = canvas;\r\n      props.gradientRendererRef?.(gradientRenderer);\r\n      gradientCanvas.classList.add(styles.CanvasCommon);\r\n    } else {\r\n      props.gradientRendererRef?.(undefined);\r\n    }\r\n\r\n    if(intensity) {\r\n      let setOpacityTo: HTMLElement;\r\n      if(image) {\r\n        setOpacityTo = image;\r\n      } else {\r\n        setOpacityTo = isDarkPattern ? gradientCanvas : patternCanvas;\r\n      }\r\n\r\n      let opacityMax = Math.abs(intensity) * (isDarkPattern ? .5 : 1);\r\n      if(image) {\r\n        opacityMax = Math.max(0.3, 1 - intensity);\r\n      } else if(isDarkPattern) {\r\n        opacityMax = Math.max(0.3, opacityMax);\r\n      }\r\n\r\n      setOpacityTo?.style.setProperty('--opacity-max', '' + opacityMax);\r\n    }\r\n\r\n    batch(() => {\r\n      setPatternCanvas(patternCanvas);\r\n      setGradientCanvas(gradientCanvas);\r\n      setImage(image);\r\n    });\r\n\r\n    if(props.onHighlightColor) {\r\n      let pixel: Uint8ClampedArray;\r\n      if(image) {\r\n        await ensureImageLoaded(image);\r\n        pixel = averageColorFromImage(image);\r\n      } else {\r\n        pixel = averageColorFromCanvas(gradientCanvas);\r\n      }\r\n\r\n      const hsla = highlightingColor(Array.from(pixel) as any);\r\n      props.onHighlightColor(hsla);\r\n    }\r\n\r\n    return {patternRenderer};\r\n  }\r\n\r\n  onMount(() => {\r\n    const onResize = () => {\r\n      ChatBackgroundPatternRenderer.resizeInstancesOf(container);\r\n    };\r\n    window.addEventListener('resize', onResize);\r\n\r\n    const promise = createBackground();\r\n\r\n    onCleanup(() => {\r\n      window.removeEventListener('resize', onResize);\r\n      promise.then(({patternRenderer}) => {\r\n        patternRenderer?.cleanup(patternCanvas());\r\n      });\r\n    });\r\n  });\r\n\r\n  return (\r\n    <div ref={container} class={classNames(styles.Container, props.class)}>\r\n      {gradientCanvas()}\r\n      {patternCanvas()}\r\n      {image()}\r\n      {url() && <img class={/* @once */ styles.CanvasCommon} style={{visibility: 'hidden'}} src={url()} />}\r\n    </div>\r\n  )\r\n}\r\n"],"names":["focusInput","input","e","placeCaretAtEnd","newEvent","SCALE_PATTERN","USE_BITMAP","IS_IMAGE_BITMAP_SUPPORTED","IS_FIREFOX","_ChatBackgroundPatternRenderer","options","instance","deepEqual","canvas","url","img","renderImageFromUrlPromise","imageBitmap","indexOfAndSplice","context","width","height","source","imageWidth","imageHeight","patternHeight","windowSize","ratio","d","y","x","centerY","topY","endY","bottomY","devicePixelRatio","mediaSizes","ScreenSize","promises","element","toResize","rect","ChatBackgroundPatternRenderer","_ChatBackgroundStore","StaticUtilityClass","slug","blur","storageUrl","canDownload","managers","appDownloadManager","canReallyDownload","_a","blob","err","wallPaper","promise","DEFAULT_BACKGROUND_SLUG","response","CacheStorageController","ChatBackgroundStore","easeOutQuadApply","v","c","WIDTH","HEIGHT","ChatBackgroundGradientRenderer","getProgress","done","id","value","transitionValue","nextPositionTail","diff","frames","i","length","arr","hex","result","hexToRgb","shift","positions","phase","curveMax","curve","pos","distances","nextPos","idx","distance","tail","curPos","progress","pixels","colorsLength","positionsForPhase","previousPhase","previous","current","offset","centerDistanceY","centerDistanceY2","centerDistanceX","swirlFactor","theta","sinTheta","cosTheta","pixelX","pixelY","distanceSum","r","g","b","colorX","colorY","distanceX","distanceY","el","colors","color","position","animateSingle","tails","nextPhaseOnIdx","inc","currentPhaseCurve","nextPhaseCurve","curves","last","ids","gradientRenderer","averageColorFromCanvas","pixel","pixelsLength","outPixel","averageColorFromImageSource","imageSource","DIMENSIONS","averageColorFromImage","image","averageColor","imageUrl","highlightingColor","rgba","h","s","l","rgbaToHsla","getBackgroundParameters","themeController","peerId","theme","getTheme","getThemeSettings","wallpaper","isUser","full","appProfileManager","getCachedFullUser","toUserId","themeEmoticon","emoticon","undefined","acctTheme","appState","accountThemes","themes","find","themeWallPaper","settings","it","backgroundUrl","getBackgroundURL","pFlags","isPattern","pattern","intensity","isDarkPattern","getWallPaperStorageUrl","ensureImageLoaded","naturalWidth","Promise","resolve","addEventListener","once","ChatBackground","props","container","patternCanvas","setPatternCanvas","createSignal","gradientCanvas","setGradientCanvas","setImage","setUrl","createBackground","patternRenderer","getBoundingClientRect","getInstance","mask","createCanvas","classList","add","styles","CanvasCommon","blend","renderToCanvas","document","createElement","renderImageFromUrl","getColorsFromWallPaper","create","gradientRendererRef","setOpacityTo","opacityMax","Math","abs","max","style","setProperty","batch","onHighlightColor","hsla","Array","from","onMount","onResize","resizeInstancesOf","window","onCleanup","removeEventListener","then","cleanup","_el$","_tmpl$","_ref$","_$use","_$insert","_c$","_$memo","_el$2","_tmpl$2","_$className","_$effect","_$setAttribute","classNames","Container","class"],"mappings":"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"}