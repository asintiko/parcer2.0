{"version":3,"file":"actions-D5-vuAkS.js","sources":["../src/lib/passcode/constants.ts","../src/helpers/bytes/compareUint8Arrays.ts","../src/lib/passcode/utils.ts","../src/lib/passcode/actions.ts"],"sourcesContent":["export const MAX_PASSCODE_LENGTH = 32;\r\nexport const SALT_LENGTH = 16;\r\n","export default function compareUint8Arrays(arr1: Uint8Array, arr2: Uint8Array) {\r\n  return arr1.length === arr2.length && arr1.every((value, index) => value === arr2[index]);\r\n}\r\n","import {SALT_LENGTH} from './constants';\r\n\r\nconst ITERATIONS = 100000;\r\n\r\nexport async function hashPasscode(passcode: string, salt: Uint8Array) {\r\n  const encoder = new TextEncoder();\r\n  const passcodeBytes = encoder.encode(passcode);\r\n  passcode = '';\r\n\r\n  const importedKey = await crypto.subtle.importKey('raw', passcodeBytes, {name: 'PBKDF2'}, false, ['deriveBits']);\r\n\r\n  const derivedBits = await crypto.subtle.deriveBits(\r\n    {name: 'PBKDF2', salt, iterations: ITERATIONS, hash: 'SHA-256'},\r\n    importedKey,\r\n    256\r\n  );\r\n\r\n  return new Uint8Array(derivedBits);\r\n}\r\n\r\nexport async function deriveEncryptionKey(passcode: string, salt: Uint8Array): Promise<CryptoKey> {\r\n  const encoder = new TextEncoder();\r\n  const passcodeBytes = encoder.encode(passcode);\r\n  passcode = '';\r\n\r\n  const importedKey = await crypto.subtle.importKey(\r\n    'raw', passcodeBytes, {name: 'PBKDF2'}, false, ['deriveKey']\r\n  );\r\n\r\n  return crypto.subtle.deriveKey(\r\n    {name: 'PBKDF2', salt, iterations: ITERATIONS, hash: 'SHA-256'},\r\n    importedKey, {name: 'AES-GCM', length: 256}, true, ['encrypt', 'decrypt']\r\n  );\r\n}\r\n\r\nexport async function createEncryptionArtifactsForPasscode(passcode: string) {\r\n  const encryptionSalt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));\r\n  const verificationSalt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));\r\n\r\n  const encryptionKey = await deriveEncryptionKey(passcode, encryptionSalt);\r\n  const verificationHash = await hashPasscode(passcode, verificationSalt);\r\n  passcode = '';\r\n\r\n  return {verificationHash, verificationSalt, encryptionSalt, encryptionKey};\r\n}\r\n","import compareUint8Arrays from '../../helpers/bytes/compareUint8Arrays';\r\nimport {joinDeepPath} from '../../helpers/object/setDeepProperty';\r\nimport {useAppSettings} from '../../stores/appSettings';\r\n\r\nimport AccountController from '../accounts/accountController';\r\nimport commonStateStorage from '../commonStateStorage';\r\nimport CacheStorageController from '../files/cacheStorage';\r\nimport {useLockScreenHotReloadGuard} from '../solidjs/hotReloadGuard';\r\n\r\nimport DeferredIsUsingPasscode from './deferredIsUsingPasscode';\r\nimport EncryptionKeyStore from './keyStore';\r\nimport {createEncryptionArtifactsForPasscode, deriveEncryptionKey, hashPasscode} from './utils';\r\n\r\nexport type PasscodeActions = ReturnType<typeof usePasscodeActions>;\r\n\r\nexport function usePasscodeActions() {\r\n  const {rootScope, apiManagerProxy} = useLockScreenHotReloadGuard();\r\n\r\n\r\n  async function disableCacheStorages() {\r\n    CacheStorageController.temporarilyToggle(false);\r\n    await apiManagerProxy.invoke('toggleCacheStorage', false);\r\n    await apiManagerProxy.serviceMessagePort.invoke('toggleCacheStorage', false);\r\n  }\r\n\r\n  async function enableCacheStorages() {\r\n    CacheStorageController.temporarilyToggle(true);\r\n    await apiManagerProxy.invoke('toggleCacheStorage', true);\r\n    await apiManagerProxy.serviceMessagePort.invoke('toggleCacheStorage', true);\r\n  }\r\n\r\n  async function clearCacheStorages() {\r\n    await CacheStorageController.clearEncryptableStorages();\r\n\r\n    CacheStorageController.resetOpenEncryptableCacheStorages();\r\n    await Promise.all([\r\n      apiManagerProxy.invoke('resetEncryptableCacheStorages', void 0),\r\n      apiManagerProxy.serviceMessagePort.invoke('resetEncryptableCacheStorages', void 0)\r\n    ]);\r\n  }\r\n\r\n  async function enablePasscode(passcode: string) {\r\n    const {verificationHash, verificationSalt, encryptionSalt, encryptionKey} =\r\n      await createEncryptionArtifactsForPasscode(passcode);\r\n\r\n    passcode = ''; // forget\r\n\r\n    await commonStateStorage.set({\r\n      passcode: {\r\n        verificationHash,\r\n        verificationSalt,\r\n        encryptionSalt\r\n      }\r\n    });\r\n\r\n    const [, setAppSettings] = useAppSettings();\r\n    await setAppSettings('passcode', 'enabled', true);\r\n\r\n    await disableCacheStorages();\r\n    await clearCacheStorages();\r\n\r\n    const togglePayload = {\r\n      isUsingPasscode: true,\r\n      encryptionKey\r\n    };\r\n    await apiManagerProxy.invoke('toggleUsingPasscode', togglePayload);\r\n    await apiManagerProxy.serviceMessagePort.invoke('toggleUsingPasscode', togglePayload);\r\n\r\n\r\n    rootScope.dispatchEvent('toggle_using_passcode', true);\r\n\r\n    // The session storage should first get encrypted in the mtproto worker, then we can use start using the encrypted proxy here\r\n    DeferredIsUsingPasscode.resolveDeferred(true);\r\n    EncryptionKeyStore.save(encryptionKey);\r\n\r\n    await enableCacheStorages();\r\n\r\n    await AccountController.updateStorageForLegacy(null); // remove access keys from unencrypted local storage\r\n  }\r\n\r\n  async function isMyPasscode(passcode: string) {\r\n    const passcodeData = await commonStateStorage.get('passcode', false);\r\n    if(!passcodeData?.verificationHash || !passcodeData?.verificationSalt) return false;\r\n\r\n    const hashed = await hashPasscode(passcode, passcodeData.verificationSalt);\r\n    passcode = ''; // forget\r\n\r\n    return compareUint8Arrays(hashed, passcodeData.verificationHash);\r\n  }\r\n\r\n  async function disablePasscode() {\r\n    const [, setAppSettings] = useAppSettings();\r\n    await setAppSettings('passcode', 'enabled', false);\r\n    rootScope.dispatchEvent('toggle_using_passcode', false);\r\n\r\n    await disableCacheStorages();\r\n    await clearCacheStorages();\r\n\r\n    await apiManagerProxy.invoke('toggleUsingPasscode', {isUsingPasscode: false});\r\n    await apiManagerProxy.serviceMessagePort.invoke('toggleUsingPasscode', {isUsingPasscode: false});\r\n\r\n    EncryptionKeyStore.save(null);\r\n    DeferredIsUsingPasscode.resolveDeferred(false);\r\n\r\n    await enableCacheStorages();\r\n\r\n    commonStateStorage.delete('passcode');\r\n  }\r\n\r\n  /**\r\n   * Note: Re-encrypts everything with a different hash even if the passcode is the same\r\n   */\r\n  async function changePasscode(passcode: string) {\r\n    const {verificationHash, verificationSalt, encryptionSalt, encryptionKey} =\r\n      await createEncryptionArtifactsForPasscode(passcode);\r\n    passcode = ''; // forget\r\n\r\n    const toStore = {\r\n      verificationHash,\r\n      verificationSalt,\r\n      encryptionSalt\r\n    }\r\n\r\n    await disableCacheStorages();\r\n    await clearCacheStorages();\r\n\r\n    await apiManagerProxy.invoke('changePasscode', {\r\n      toStore,\r\n      encryptionKey\r\n    });\r\n    await apiManagerProxy.serviceMessagePort.invoke('saveEncryptionKey', encryptionKey);\r\n\r\n    EncryptionKeyStore.save(encryptionKey);\r\n\r\n    await enableCacheStorages();\r\n    // Just to set local cache, not really needed)\r\n    await commonStateStorage.set({\r\n      passcode: toStore\r\n    }, true);\r\n  }\r\n\r\n  /**\r\n   * Warning! don't call on an unverified password\r\n   */\r\n  async function unlockWithPasscode(passcode: string) {\r\n    const passcodeData = await commonStateStorage.get('passcode', false);\r\n    if(!passcodeData?.encryptionSalt) throw new Error('No encryption salt found in storage');\r\n\r\n    const encryptionKey = await deriveEncryptionKey(passcode, passcodeData.encryptionSalt);\r\n    passcode = ''; // forget;\r\n\r\n    EncryptionKeyStore.save(encryptionKey);\r\n    await apiManagerProxy.invoke('saveEncryptionKey', encryptionKey);\r\n    // Make sure we resolve the DeferredIsUsingPasscode as there is no storage available in SW to get the value\r\n    await apiManagerProxy.serviceMessagePort.invoke('toggleUsingPasscode', {isUsingPasscode: true, encryptionKey});\r\n\r\n    apiManagerProxy.invokeVoid('toggleLockOthers', false);\r\n    rootScope.dispatchEvent('toggle_locked', false);\r\n  }\r\n\r\n  return {\r\n    enablePasscode,\r\n    isMyPasscode,\r\n    disablePasscode,\r\n    changePasscode,\r\n    unlockWithPasscode\r\n  };\r\n}\r\n"],"names":["MAX_PASSCODE_LENGTH","SALT_LENGTH","compareUint8Arrays","arr1","arr2","value","index","ITERATIONS","hashPasscode","passcode","salt","passcodeBytes","importedKey","derivedBits","deriveEncryptionKey","createEncryptionArtifactsForPasscode","encryptionSalt","verificationSalt","encryptionKey","verificationHash","usePasscodeActions","rootScope","apiManagerProxy","useLockScreenHotReloadGuard","disableCacheStorages","CacheStorageController","enableCacheStorages","clearCacheStorages","enablePasscode","commonStateStorage","setAppSettings","useAppSettings","togglePayload","DeferredIsUsingPasscode","EncryptionKeyStore","AccountController","isMyPasscode","passcodeData","hashed","disablePasscode","changePasscode","toStore","unlockWithPasscode"],"mappings":"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"}