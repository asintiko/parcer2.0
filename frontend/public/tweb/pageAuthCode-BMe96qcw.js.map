{"version":3,"mappings":"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","names":["authSentCode","headerElement","sentTypeElement","codeInputField","codeInputErrorLabel","resetEmailElement","resetEmailTimer","monkey","player","cleanup","submitCode","code","params","rootScope","response","__vitePreload","m","err","good","replaceContent","i18n","fastRaf","onFirstMount","inputWrapper","page","editButton","Icon","attachClickEvent","pageSignIn","getAnimation","imageDiv","size","mediaSizes","container","lottieLoader","animation","TrackingMonkey","handleResetEmail","updatePendingEmail","render","toastNew","SimpleConfirmationPopup","diff","tsNow","wrapFormattedDuration","formatDuration","anchorCallback","ctx","CODE_LENGTH","CodeInputFieldCompat","key","args","authSentCodeType","a","setBlankToAnchor","wrapEmailPattern","Page","_authCode"],"ignoreList":[],"sources":["../src/pages/pageAuthCode.ts"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from '../helpers/mediaSizes';\r\nimport {AuthSentCode, AuthSentCodeType, AuthSignIn} from '../layer';\r\nimport Page from './page';\r\nimport pageSignIn from './pageSignIn';\r\nimport TrackingMonkey from '../components/monkeys/tracking';\r\nimport CodeInputFieldCompat from '../components/codeInputField';\r\nimport {i18n, LangPackKey} from '../lib/langPack';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\nimport rootScope from '../lib/rootScope';\r\nimport lottieLoader from '../lib/rlottie/lottieLoader';\r\nimport RLottiePlayer from '../lib/rlottie/rlottiePlayer';\r\nimport setBlankToAnchor from '../lib/richTextProcessor/setBlankToAnchor';\r\nimport {attachClickEvent} from '../helpers/dom/clickEvent';\r\nimport Icon from '../components/icon';\r\nimport {fastRaf} from '../helpers/schedulers';\r\nimport {wrapEmailPattern} from '../components/popups/emailSetup';\r\nimport anchorCallback from '../helpers/dom/anchorCallback';\r\nimport tsNow from '../helpers/tsNow';\r\nimport {wrapFormattedDuration} from '../components/wrappers/wrapDuration';\r\nimport formatDuration from '../helpers/formatDuration';\r\nimport {SimpleConfirmationPopup} from './loginPage';\r\nimport {toastNew} from '../components/toast';\r\nimport ctx from '../environment/ctx';\r\n\r\nlet authSentCode: AuthSentCode.authSentCode = null;\r\n\r\nlet headerElement: HTMLHeadElement = null;\r\nlet sentTypeElement: HTMLParagraphElement = null;\r\nlet codeInputField: CodeInputFieldCompat;\r\nlet codeInputErrorLabel: HTMLElement;\r\nlet resetEmailElement: HTMLDivElement, resetEmailTimer: number;\r\nlet monkey: TrackingMonkey, player: RLottiePlayer;\r\n\r\nconst cleanup = () => {\r\n  setTimeout(() => {\r\n    monkey?.remove();\r\n    player?.remove();\r\n    codeInputField?.cleanup()\r\n    if(resetEmailTimer) clearTimeout(resetEmailTimer);\r\n  }, 300);\r\n};\r\n\r\nconst submitCode = (code: string) => {\r\n  codeInputField.disabled = true;\r\n\r\n  const params: AuthSignIn = {\r\n    phone_number: authSentCode.phone_number,\r\n    phone_code_hash: authSentCode.phone_code_hash,\r\n    phone_code: code\r\n  };\r\n\r\n  // console.log('invoking auth.signIn with params:', params);\r\n\r\n  rootScope.managers.apiManager.invokeApi('auth.signIn', params, {ignoreErrors: true})\r\n  .then(async(response) => {\r\n    // console.log('auth.signIn response:', response);\r\n\r\n    switch(response._) {\r\n      case 'auth.authorization':\r\n        await rootScope.managers.apiManager.setUser(response.user);\r\n\r\n        import('./pageIm').then((m) => {\r\n          m.default.mount();\r\n        });\r\n        cleanup();\r\n        break;\r\n      case 'auth.authorizationSignUpRequired':\r\n        // console.log('Registration needed!');\r\n\r\n        import('./pageSignUp').then((m) => {\r\n          m.default.mount({\r\n            'phone_number': authSentCode.phone_number,\r\n            'phone_code_hash': authSentCode.phone_code_hash\r\n          });\r\n        });\r\n\r\n        cleanup();\r\n        break;\r\n      /* default:\r\n        codeInput.innerText = response._;\r\n        break; */\r\n    }\r\n  }).catch(async(err) => {\r\n    let good = false;\r\n    switch(err.type) {\r\n      case 'SESSION_PASSWORD_NEEDED':\r\n        // console.warn('pageAuthCode: SESSION_PASSWORD_NEEDED');\r\n        good = true;\r\n        await (await import('./pagePassword')).default.mount(); // lol\r\n        setTimeout(() => {\r\n          codeInputField.value = '';\r\n        }, 300);\r\n        break;\r\n      case 'PHONE_CODE_EXPIRED':\r\n        codeInputField.error = true;\r\n        replaceContent(codeInputErrorLabel, i18n('PHONE_CODE_EXPIRED'));\r\n        break;\r\n      case 'PHONE_CODE_EMPTY':\r\n      case 'PHONE_CODE_INVALID':\r\n        codeInputField.error = true;\r\n        replaceContent(codeInputErrorLabel, i18n('PHONE_CODE_INVALID'));\r\n        break;\r\n      default:\r\n        codeInputField.error = true;\r\n        replaceContent(codeInputErrorLabel, err.type);\r\n        break;\r\n    }\r\n\r\n    codeInputField.disabled = false;\r\n\r\n    if(!good) {\r\n      codeInputField.value = '';\r\n      fastRaf(() => {\r\n        codeInputField.input.focus();\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\nconst onFirstMount = () => {\r\n  const inputWrapper = page.pageEl.querySelector('.input-wrapper') as HTMLDivElement;\r\n  inputWrapper.append(codeInputField.container);\r\n\r\n  codeInputErrorLabel = document.createElement('div');\r\n  codeInputErrorLabel.classList.add('error-label');\r\n  inputWrapper.append(codeInputErrorLabel);\r\n\r\n  const editButton = page.pageEl.querySelector('.phone-edit') as HTMLElement;\r\n  editButton.append(Icon('edit'));\r\n  attachClickEvent(editButton, () => {\r\n    return pageSignIn.mount();\r\n  });\r\n\r\n  inputWrapper.append(resetEmailElement);\r\n};\r\n\r\nconst getAnimation = () => {\r\n  const imageDiv = page.pageEl.querySelector('.auth-image') as HTMLDivElement;\r\n  const size = mediaSizes.isMobile ? 100 : 166;\r\n  if(authSentCode.type._ === 'auth.sentCodeTypeFragmentSms') {\r\n    if(imageDiv.firstElementChild) {\r\n      monkey?.remove();\r\n      monkey = undefined;\r\n      imageDiv.replaceChildren();\r\n    }\r\n\r\n    const container = document.createElement('div');\r\n    container.classList.add('media-sticker-wrapper');\r\n    imageDiv.append(container);\r\n    return lottieLoader.loadAnimationAsAsset({\r\n      container: container,\r\n      loop: true,\r\n      autoplay: true,\r\n      width: size,\r\n      height: size\r\n    }, 'jolly_roger').then((animation) => {\r\n      player = animation;\r\n      return lottieLoader.waitForFirstFrame(animation);\r\n    }).then(() => {});\r\n  } else {\r\n    if(imageDiv.firstElementChild) {\r\n      player?.remove();\r\n      player = undefined;\r\n      imageDiv.replaceChildren();\r\n    }\r\n\r\n    monkey = new TrackingMonkey(codeInputField, size);\r\n    imageDiv.append(monkey.container);\r\n    return monkey.load();\r\n  }\r\n};\r\n\r\nconst handleResetEmail = () => {\r\n  rootScope.managers.apiManager.invokeApi('auth.resetLoginEmail', {\r\n    phone_number: authSentCode.phone_number,\r\n    phone_code_hash: authSentCode.phone_code_hash\r\n  }).then((code) => {\r\n    if(code._ === 'auth.sentCode') {\r\n      code.phone_number = authSentCode.phone_number;\r\n      authSentCode = code;\r\n      if(code.type._ === 'auth.sentCodeTypeEmailCode') {\r\n        updatePendingEmail(code.type);\r\n      } else {\r\n        render();\r\n      }\r\n    } else {\r\n      console.error(code);\r\n      toastNew({langPackKey: 'Error.AnError'});\r\n    }\r\n  }).catch((err: ApiError) => {\r\n    if(err.type.includes('TASK_ALREADY_EXISTS')) {\r\n      SimpleConfirmationPopup.show({\r\n        titleLangKey: 'Login.ResetEmail.NeedPremium',\r\n        descriptionLangKey: 'Login.ResetEmail.NeedPremiumText',\r\n        button: {\r\n          langKey: 'OK'\r\n        }\r\n      })\r\n    } else {\r\n      console.error(err);\r\n      toastNew({langPackKey: 'Error.AnError'});\r\n    }\r\n  })\r\n}\r\n\r\nconst updatePendingEmail = (code: AuthSentCodeType.authSentCodeTypeEmailCode) => {\r\n  if(resetEmailTimer) clearTimeout(resetEmailTimer);\r\n\r\n  if(code.reset_pending_date != null) {\r\n    const diff = code.reset_pending_date - tsNow(true);\r\n    if(diff <= 0 || code.reset_pending_date <= 0) {\r\n      resetEmailElement.replaceChildren(i18n('Login.ResetEmail.PleaseWait'));\r\n      handleResetEmail();\r\n      return\r\n    }\r\n\r\n    resetEmailElement.replaceChildren(i18n('Login.ResetEmail.Pending', [\r\n      wrapFormattedDuration(formatDuration(diff, 2)),\r\n      anchorCallback(handleResetEmail)\r\n    ]));\r\n    resetEmailTimer = ctx.setTimeout(() => updatePendingEmail(code), 30_000);\r\n    return;\r\n  }\r\n\r\n  if(code.reset_available_period != null) {\r\n    resetEmailElement.replaceChildren(i18n('TroubleEmail', [\r\n      anchorCallback(() => {\r\n        SimpleConfirmationPopup.show({\r\n          titleLangKey: 'Login.ResetEmail.Title',\r\n          descriptionLangKey: 'Login.ResetEmail.Text',\r\n          descriptionArgs: [wrapFormattedDuration(formatDuration(code.reset_available_period, 2))],\r\n          button: {\r\n            langKey: 'Login.ResetEmail.Title'\r\n          }\r\n        }).then(() => {\r\n          handleResetEmail();\r\n        })\r\n      })\r\n    ]));\r\n  }\r\n}\r\n\r\nconst render = () => {\r\n  if(!headerElement) {\r\n    headerElement = page.pageEl.getElementsByClassName('phone')[0] as HTMLHeadElement;\r\n    sentTypeElement = page.pageEl.getElementsByClassName('sent-type')[0] as HTMLParagraphElement;\r\n  } else {\r\n    codeInputField.value = '';\r\n  }\r\n\r\n  const CODE_LENGTH = (authSentCode.type as AuthSentCodeType.authSentCodeTypeApp).length;\r\n  if(!codeInputField) {\r\n    codeInputField = new CodeInputFieldCompat({\r\n      length: CODE_LENGTH,\r\n      onChange: (code) => {\r\n        codeInputField.error = false;\r\n        replaceContent(codeInputErrorLabel, '');\r\n      },\r\n      onFill: (code) => {\r\n        submitCode(code);\r\n      }\r\n    });\r\n  }\r\n\r\n  codeInputField.options.length = CODE_LENGTH;\r\n\r\n  headerElement.innerText = authSentCode.phone_number;\r\n  if(!resetEmailElement) {\r\n    resetEmailElement = document.createElement('div');\r\n    resetEmailElement.classList.add('forgot-link');\r\n  }\r\n  resetEmailElement.innerHTML = '';\r\n  if(resetEmailTimer) clearTimeout(resetEmailTimer);\r\n\r\n  let key: LangPackKey, args: any[];\r\n  const authSentCodeType = authSentCode.type;\r\n  switch(authSentCodeType._) {\r\n    case 'auth.sentCodeTypeSms':\r\n      key = 'Login.Code.SentSms';\r\n      break;\r\n    case 'auth.sentCodeTypeApp':\r\n      key = 'Login.Code.SentInApp';\r\n      break;\r\n    case 'auth.sentCodeTypeCall':\r\n      key = 'Login.Code.SentCall';\r\n      break;\r\n    case 'auth.sentCodeTypeFragmentSms':\r\n      key = 'PhoneNumber.Code.Fragment.Info';\r\n      const a = document.createElement('a');\r\n      setBlankToAnchor(a);\r\n      a.href = authSentCodeType.url;\r\n      args = [a];\r\n      break;\r\n    case 'auth.sentCodeTypeEmailCode':\r\n      key = 'Login.Code.SentEmail';\r\n      args = [wrapEmailPattern(authSentCodeType.email_pattern)];\r\n      updatePendingEmail(authSentCodeType);\r\n      break;\r\n    default:\r\n      key = 'Login.Code.SentUnknown';\r\n      args = [authSentCodeType._];\r\n      break;\r\n  }\r\n\r\n  replaceContent(sentTypeElement, i18n(key, args));\r\n\r\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStateAuthCode', sentCode: authSentCode});\r\n\r\n  return getAnimation().catch(() => {});\r\n}\r\n\r\nconst page = new Page('page-authCode', true, onFirstMount, (_authCode: typeof authSentCode) => {\r\n  authSentCode = _authCode;\r\n  render()\r\n}, () => {\r\n  fastRaf(() => {\r\n    codeInputField?.input.focus();\r\n  })\r\n});\r\n\r\nexport default page;\r\n"],"file":"pageAuthCode-BMe96qcw.js"}